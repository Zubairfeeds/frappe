(()=>{var E=Object.defineProperty;var k=Object.getOwnPropertySymbols;var I=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable;var N=(i,e,t)=>e in i?E(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,S=(i,e)=>{for(var t in e||(e={}))I.call(e,t)&&N(i,t,e[t]);if(k)for(var t of k(e))B.call(e,t)&&N(i,t,e[t]);return i};frappe.ui.OnboardingTour=class{constructor(){this.driver_steps=[],this.last_step_saved=null,this.last_element_clicked=null}init_driver(){this.driver=new frappe.Driver({className:"frappe-driver",allowClose:!1,padding:10,overlayClickNext:!1,keyboardControl:!0,nextBtnText:"Next",prevBtnText:"Previous",opacity:.5,onHighlighted:e=>{var n;frappe.ui.next_form_tour=(n=e.options.step_info)==null?void 0:n.next_form_tour;let t=setInterval(()=>{var p,a;!e.popover.node||((p=e.options.step_info)!=null&&p.offset_x&&(e.popover.node.style.left=`${e.popover.node.offsetLeft+e.options.step_info.offset_x}px`),(a=e.options.step_info)!=null&&a.offset_y&&(e.popover.node.style.top=`${e.popover.node.offsetTop+e.options.step_info.offset_y}px`),e.popover.node.offsetLeft<0&&(e.popover.node.style.minWidth="200px",e.popover.node.style.maxWidth=`${350+e.popover.node.offsetLeft}px`,e.popover.node.style.left="0px"),e.popover.closeBtnNode&&(e.popover.closeBtnNode.onclick=()=>{this.on_finish&&this.on_finish(),!frappe.boot.user.onboarding_status[this.tour.name]&&(frappe.boot.user.onboarding_status[this.tour.name]={}),frappe.boot.user.onboarding_status[this.tour.name].is_complete=!0,this.driver.hasNextStep()||(frappe.boot.user.onboarding_status[this.tour.name].all_steps_completed=!0),frappe.call({method:"frappe.desk.doctype.form_tour.form_tour.update_user_status",args:{value:JSON.stringify(frappe.boot.user.onboarding_status),step:JSON.stringify(e.options.step_info)}})}),clearInterval(t))},300),r=$(e.node).find("input").get(0);r&&frappe.utils.sleep(200).then(()=>r.focus())}})}async init({tour_name:e,start_step:t}){this.tour=await frappe.db.get_doc("Form Tour",e),this.init_driver(),this.build_steps(),this.update_driver_steps(),this.tour.track_steps||(t=0),this.start(t)}build_steps(){this.driver_steps=[],this.tour.steps.forEach(e=>{let t=async n=>{var a;let p=this.driver.steps.indexOf(n);p==-1||((a=this.last_step_saved)==null?void 0:a.name)==e.name||(frappe.boot.user.onboarding_status[this.tour.name]={steps_complete:p},this.driver.hasNextStep()||(this.on_finish&&this.on_finish(),frappe.boot.user.onboarding_status[this.tour.name].is_complete=!0),this.last_step_saved=e,frappe.call({method:"frappe.desk.doctype.form_tour.form_tour.update_user_status",args:{value:JSON.stringify(frappe.boot.user.onboarding_status),step:JSON.stringify(e)}}))},r=this.get_step(e,t);r.element&&this.driver_steps.push(r)})}get_step(e,t){let{name:r,element_selector:n,title:p,description:a,ondemand_description:u,position:f,parent_element_selector:s,hide_buttons:o,next_on_click:h,popover_element:v,modal_trigger:c}=e,d=cur_page==null?void 0:cur_page.page.querySelector(n);!d&&(d=document.querySelector(n)),s&&(d=d.closest(s)),d&&(h||o||c)&&$(d).on("click",()=>{var y,x;if(!this.driver.getHighlightedElement()||((y=this.driver.getHighlightedElement().node.id)==null?void 0:y.startsWith("popover")))return;if(c&&(!this.last_element_clicked||new Date().getTime()-new Date(this.last_element_clicked).getTime()>1e3)){this.last_element_clicked=new Date().getTime(),this.handle_modal_steps(this.driver.currentStep,p,u);return}if(v||(t(this.driver.getHighlightedElement()),this.driver.moveNext(),this.driver.overlay.refresh()),!this.driver.getHighlightedElement())return;t(this.driver.getHighlightedElement());let _=this.driver.getHighlightedElement().node.getAttribute("aria-describedby")?this.driver.getHighlightedElement().node:this.driver.getHighlightedElement().node.querySelector('[aria-describedby^="popover"]');if(!_)return;let m=_.getAttribute("aria-describedby"),b=this.driver.steps.indexOf(this.driver.getHighlightedElement());if(((x=this.driver_steps[b+1])==null?void 0:x.element.id)==m)return;this.driver_steps=this.driver_steps.filter(w=>{var T;return!((T=w.element.id)!=null&&T.startsWith("popover"))});let l=S({},this.driver_steps[b]);l.element=document.getElementById(m),l.showButtons=!1,u&&(l.popover.description=u),this.driver_steps.splice(this.driver.currentStep+1,0,l),this.update_driver_steps(),this.driver.moveNext(),this.driver.overlay.refresh(),$(_).one("hide.bs.popover",w=>{this.driver_steps.splice(this.driver.currentStep,1),this.driver_steps[this.driver.currentStep-1].showButtons=!0,l.popover.description=a,this.update_driver_steps(),this.driver.movePrevious(),this.driver.overlay.refresh()})});let g=!0;return(v||o)&&(g=!1),{element:d,name:r,popover:{title:p,description:a,position:frappe.router.slug(f||"Bottom")},onNext:t,step_info:e,showButtons:g}}update_driver_steps(e=[]){e.length==0&&(e=this.driver_steps),this.driver.defineSteps(e)}start(e=0){this.driver_steps.length!=0&&this.driver.start(e)}handle_modal_steps(e,t,r){setTimeout(()=>{let n=$(".modal-content"),p={element:n[0],allowClose:!1,overlayClickNext:!1,popover:{title:t,description:r,position:"left-center",doneBtnText:__("Next")}};this.driver_steps.splice(e+1,0,p),this.update_driver_steps(),this.driver.reset(),this.driver.start(e+1),this.driver.overlay.refresh(),n.closest(".modal").one("hide.bs.modal",()=>{this.driver_steps.splice(this.driver.currentStep,1),this.update_driver_steps(),this.driver.movePrevious(),this.driver.moveNext(),this.driver.overlay.refresh()})},500)}};frappe.ui.init_onboarding_tour=()=>{var f;if(!window.matchMedia("(min-device-width: 992px)").matches)return;typeof frappe.boot.onboarding_tours=="undefined"&&frappe.boot.onboarding_tours==[],typeof frappe.boot.user.onboarding_status=="undefined"&&frappe.boot.user.onboarding_status=={};let i=frappe.router.current_route;if(i[0]==="")return;let e,t=[],r;if(i[0]=="query-report"&&(i=["List",i[1],"Report"]),i[0]!="dashboard-view"&&frappe.boot.onboarding_tours&&frappe.boot.onboarding_tours.forEach(s=>{let o=s[1];length=Math.min(i.length,o.length),!(length>=1&&i[0]!=o[0])&&(length>=2&&o[1]!="*"&&i[1]!=o[1]||length>=3&&["*","new-*"].indexOf(o[2])==-1&&i[2]!=o[2]||t.push(s))}),t=t.filter(s=>{var o;return((o=frappe.boot.user.onboarding_status[s[0]])==null?void 0:o.is_complete)!=!0}),t=t.map(s=>{var o;return((o=frappe.boot.user.onboarding_status[s[0]])==null?void 0:o.steps_complete)!=null&&s.push(frappe.boot.user.onboarding_status[s[0]].steps_complete),s}),t.length==0)return;let n=t.find(s=>{var o,h;return s[0]==((h=(o=frappe.ui.currentTourInstance)==null?void 0:o.tour)==null?void 0:h.name)}),p=t.find(s=>s[0]==frappe.ui.next_form_tour);if(n?(e=n[0],r=n.at(-1),typeof r!="number"&&(r=0)):p?(e=p[0],r=p.at(-1),typeof r!="number"?r=0:r+=1,frappe.ui.next_form_tour=void 0):(e=t[0][0],r=t[0].at(-1),typeof r!="number"?r=0:r+=1),!e)return;(f=frappe.ui.currentTourInstance)!=null&&f.driver&&(frappe.ui.currentTourInstance.driver_steps=[],frappe.ui.currentTourInstance.driver.reset(!0),frappe.ui.currentTourInstance.update_driver_steps());let a=frappe.ui.currentTourInstance=new frappe.ui.OnboardingTour,u=setInterval(()=>{cur_page!=null&&cur_page.page.querySelector(".workspace-sidebar-skeleton")||cur_page!=null&&cur_page.page.querySelector(".workspace-skeleton")||document.body.getAttribute("data-ajax-state")==="complete"&&frappe.utils.sleep(500).then(()=>{a.init({tour_name:e,start_step:r}),clearInterval(u)})},100)};frappe.router.on("change",()=>{frappe.ui.init_onboarding_tour()});})();
//# sourceMappingURL=onboarding_tours.bundle.R5ISHVV4.js.map
